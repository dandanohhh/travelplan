<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Tokyo Trip V46</title>
    
    <!-- 1. æ¨£å¼åº« -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- 2. æ ¸å¿ƒé‚è¼¯åº« (æ”¹å› Global æ¨¡å¼ï¼Œæœ€ç©©å®š) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        /* --- é£›å¤©å°å¥³è­¦é…è‰² --- */
        :root {
            --bg-color: #FFF0F5;
            --primary: #333333;
            --blossom: #FF4081;
            --bubbles: #00BCD4;
            --buttercup: #8BC34A;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--primary);
            padding-bottom: 120px;
            -webkit-tap-highlight-color: transparent;
            /* é‡å° iOS å…è¨±å…¨åŸŸé»æ“Š */
            user-select: auto; 
        }
        .safe-top { padding-top: max(20px, env(safe-area-inset-top)); }
        
        /* è¼¸å…¥æ¡†å¼·åˆ¶è§£é– (è²¼ä¸Šä¿®å¾©) */
        input, textarea, select {
            user-select: text !important;
            -webkit-user-select: text !important;
            -webkit-touch-callout: default !important;
            pointer-events: auto !important;
            cursor: auto !important;
            outline: none; 
            background: transparent;
        }

        /* ç¦æ­¢é¸å–çš„å…ƒç´  */
        .noselect { user-select: none; -webkit-user-select: none; }

        /* å¡ç‰‡æ¨£å¼ */
        .ppg-card { background-color: white; border-radius: 20px; border: 3px solid white; box-shadow: 0 6px 16px rgba(255, 64, 129, 0.15); transition: transform 0.1s; }
        .ppg-card:active { transform: scale(0.98); }
        .completed-card { background: #8BC34A !important; color: white !important; border-color: #8BC34A !important; }
        .completed-card input { color: white !important; }
        .completed-card .text-secondary { color: rgba(255,255,255,0.8) !important; }
        .completed-card i { color: white !important; }
        
        .hotel-card { background: linear-gradient(135deg, #FF4081 0%, #F50057 100%); color: white; border-radius: 20px; box-shadow: 0 8px 20px rgba(255, 64, 129, 0.3); }
        .glass-nav { background: rgba(255, 255, 255, 0.95); border-top: 1px solid rgba(255, 64, 129, 0.1); padding-bottom: env(safe-area-inset-bottom); box-shadow: 0 -4px 10px rgba(0,0,0,0.05); }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .file-input { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10; left: 0; top: 0;}
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 100; display: flex; justify-content: center; items-center; padding: 20px; }
        .swipe-item { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; }
        .swipe-content { min-width: 100%; scroll-snap-align: start; }
        .swipe-action { min-width: 80px; scroll-snap-align: end; }
        .route-connector { position: relative; margin-left: 28px; padding-left: 20px; border-left: 3px dashed #FFCDD2; padding-top: 12px; padding-bottom: 12px; }
        
        select { padding-right: 0 !important; text-align-last: center; }

        /* é è¨­éš±è—æ•‘æ´æŒ‰éˆ•ï¼Œåªæœ‰å‡ºéŒ¯æ‰é¡¯ç¤º */
        #rescue-layer { display: block; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 0; text-align: center; width: 80%; opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body class="safe-top h-screen flex flex-col">

    <!-- éœæ…‹æ•‘æ´å±¤ (å¦‚æœ Vue è·‘èµ·ä¾†ï¼Œé€™å€‹æœƒè¢«è“‹ä½) -->
    <div id="rescue-layer">
        <div class="text-4xl mb-4">â³</div>
        <div class="text-sm font-bold text-[#FF4081]">æ­£åœ¨å•Ÿå‹• App...</div>
        <div class="text-xs text-gray-400 mt-2">è‹¥å¡ä½è¶…é 3 ç§’<br>è«‹é‡æ–°æ•´ç†æˆ–æ¸…é™¤å¿«å–</div>
        <!-- è¬ä¸€çœŸçš„å¡æ­»ï¼Œå¯ä»¥é»é€™å€‹ -->
        <button onclick="localStorage.clear();location.reload()" style="margin-top:20px; pointer-events:auto; text-decoration:underline; font-size:10px;">
            é»æ­¤å¼·åˆ¶é‡ç½®è³‡æ–™
        </button>
    </div>

    <!-- App ä¸»é«” -->
    <div id="app" class="h-full flex flex-col relative z-10 bg-[#FFF0F5]" style="min-height: 100vh;">

        <!-- Header -->
        <header class="px-6 pt-4 pb-4 bg-[#FFF0F5] sticky top-0 z-30 shadow-sm noselect">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-black tracking-wide text-[#FF4081]">
                        TOKYO <i class="fa-solid fa-heart text-[#00BCD4]"></i>
                    </h1>
                    <p class="text-[10px] text-[#00BCD4] font-bold tracking-widest uppercase">Powerpuff Trip</p>
                </div>
                <button @click="showSettings = true" class="w-10 h-10 rounded-full bg-white shadow text-[#FF4081] flex items-center justify-center active:bg-gray-100">
                    <i class="fa-solid fa-gear"></i>
                </button>
            </div>
        </header>

        <!-- 1. è¡Œç¨‹è¡¨ (Schedule) -->
        <div v-if="currentTab === 'schedule'" class="px-5 pb-10 flex-1 overflow-y-auto hide-scrollbar">
            <!-- å¤©æ•¸åˆ‡æ› -->
            <div class="flex items-center justify-between mb-6 pt-2 noselect">
                <div class="flex overflow-x-auto hide-scrollbar gap-3 w-3/4 py-1">
                    <button v-for="(day, index) in itinerary" :key="index" @click="changeDay(index)"
                        class="px-5 py-2 rounded-2xl whitespace-nowrap text-xs font-bold border-2 flex flex-col items-center justify-center h-14 min-w-[70px] transition-all"
                        :class="currentDayIndex === index ? 'bg-[#FF4081] text-white border-[#FF4081]' : 'bg-white text-[#FF4081] border-white'">
                        <span>Day {{ index + 1 }}</span>
                        <span v-if="startDate" class="text-[9px] font-light opacity-90 leading-none mt-0.5">{{ getDayDate(index) }}</span>
                    </button>
                    <button @click="addDay" class="px-4 rounded-2xl bg-white border-2 border-[#FFCDD2] text-[#FF4081] h-14 active:bg-pink-50"><i class="fa-solid fa-plus"></i></button>
                </div>
                <a :href="getDailyRouteLink()" target="_blank" class="flex flex-col items-center justify-center text-[#00BCD4] text-[9px] font-bold bg-white border-2 border-[#E0F7FA] w-14 h-14 rounded-2xl active:bg-cyan-50">
                    <i class="fa-solid fa-map text-xl mb-1"></i> å…¨æ—¥
                </a>
            </div>

            <div v-if="startDate" class="text-center text-[#FF4081] font-bold text-sm mb-4 noselect">{{ getFullDayDate(currentDayIndex) }}</div>

            <div class="space-y-4" id="sortable-list">
                <template v-for="(event, idx) in itinerary[currentDayIndex].events" :key="event.id">
                    
                    <div class="ppg-card p-5 relative z-10 group" :data-id="event.id">
                        <!-- å³ä¸Šè§’åŠŸèƒ½å€ -->
                        <div class="absolute top-2 right-2 flex gap-2 noselect">
                            <button @click="openMoveModal(idx)" class="text-[#00BCD4] p-1 hover:bg-[#E0F7FA] rounded transition">
                                <i class="fa-solid fa-right-to-bracket"></i>
                            </button>
                            <button @click="removeEvent(idx)" class="text-[#FFCDD2] p-1 hover:text-[#FF4081] transition">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                        
                        <div class="flex gap-4 items-start">
                            <div class="drag-handle text-[#FFCDD2] pt-3 px-1 noselect"><i class="fa-solid fa-grip-vertical"></i></div>
                            <div class="flex flex-col items-center w-14 pt-1 shrink-0">
                                <input type="time" v-model="event.time" class="text-xs font-bold text-[#333] mb-2 bg-[#FFF0F5] border border-[#FFCDD2] px-1 py-1 rounded w-full text-center">
                                <div class="relative w-10 h-10">
                                    <select v-model="event.transport" class="appearance-none bg-[#E0F7FA] text-[#00BCD4] text-lg rounded-full w-full h-full flex items-center justify-center text-center pl-1 font-bold">
                                        <option value="train">ğŸš‡</option><option value="walk">ğŸš¶</option><option value="taxi">ğŸš•</option><option value="bus">ğŸšŒ</option><option value="plane">âœˆï¸</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex-1 pt-1 min-w-0 pr-10">
                                <input type="text" v-model="event.location" placeholder="åœ°é» (å¯è²¼ä¸Š)" class="w-full text-lg font-bold text-[#333] mb-1 placeholder-[#FFCDD2]">
                                <input type="text" v-model="event.note" placeholder="å‚™è¨» (å¯è²¼ä¸Š)..." class="w-full text-xs text-[#FF4081] mb-3 opacity-80 placeholder-[#FFCDD2]">
                                <div class="flex items-center gap-3 noselect">
                                    <a :href="getMapLink(event.location)" target="_blank" class="inline-flex items-center text-[10px] font-bold text-white bg-[#00BCD4] px-3 py-1.5 rounded-full shadow-md">
                                        <i class="fa-solid fa-location-arrow mr-1.5"></i> å°èˆª
                                    </a>
                                    <div class="relative w-8 h-8 rounded-full bg-[#FFF0F5] flex items-center justify-center text-[#FFCDD2] border-2 border-[#FFCDD2] overflow-hidden clickable">
                                        <img v-if="event.image" :src="event.image" class="w-full h-full object-cover" @click="viewImage(event.image)">
                                        <i v-else class="fa-solid fa-camera text-xs"></i>
                                        <input v-if="!event.image" type="file" accept="image/*" class="file-input" @change="handleImageUpload($event, event)">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- è‡ªå‹•å°èˆªæŒ‰éˆ• -->
                    <div v-if="idx < itinerary[currentDayIndex].events.length - 1" class="route-connector flex items-center noselect">
                        <a :href="getRouteLink(event, itinerary[currentDayIndex].events[idx+1])" target="_blank" 
                           class="bg-white border-2 border-[#00BCD4] text-[#00BCD4] px-4 py-1 rounded-full text-[10px] font-bold shadow-sm flex items-center gap-1.5 active:bg-cyan-50">
                            <i v-if="event.transport === 'walk'" class="fa-solid fa-person-walking"></i>
                            <i v-else-if="event.transport === 'taxi'" class="fa-solid fa-car"></i>
                            <i v-else class="fa-solid fa-train-subway"></i>
                            æŸ¥è©¢è·¯ç·š
                        </a>
                    </div>
                </template>

                <div class="mt-6 noselect">
                    <button @click="addEvent" class="w-full py-4 rounded-2xl border-2 border-dashed border-[#FF80AB] text-[#FF80AB] text-xs font-bold tracking-widest bg-white active:bg-pink-50">+ ADD PLAN</button>
                </div>

                <div class="mt-10 pt-6 border-t-2 border-[#FFCDD2] noselect">
                    <div class="flex justify-between items-center mb-3">
                         <h3 class="text-[10px] font-bold text-[#FF4081] tracking-widest uppercase pl-1">Tonight's Stay</h3>
                         <button v-if="currentDayIndex > 0" @click="copyFromPreviousDay" class="text-[10px] bg-[#FF4081] text-white px-3 py-1 rounded-full shadow-sm hover:bg-[#F50057] transition font-bold">
                             <i class="fa-solid fa-copy mr-1"></i> åŒå‰ä¸€æ™š
                         </button>
                    </div>
                   
                    <div class="hotel-card p-6 relative">
                        <div class="flex items-start gap-4">
                            <div class="mt-1 text-white"><i class="fa-solid fa-hotel"></i></div>
                            <div class="flex-1 min-w-0">
                                <input v-model="itinerary[currentDayIndex].accommodation.name" class="w-full text-white font-bold text-lg placeholder-white/50 mb-1 bg-transparent" placeholder="è¼¸å…¥é£¯åº—åç¨±">
                                <input v-model="itinerary[currentDayIndex].accommodation.note" class="w-full text-white/80 text-xs placeholder-white/40 bg-transparent" placeholder="è¨‚æˆ¿ä»£è™Ÿ">
                                <div class="mt-4 flex items-center gap-3">
                                    <a :href="getMapLink(itinerary[currentDayIndex].accommodation.name)" target="_blank" class="w-8 h-8 rounded-full bg-white text-[#FF4081] flex items-center justify-center text-xs shadow"><i class="fa-solid fa-location-dot"></i></a>
                                    <div class="relative px-3 py-1.5 rounded-lg bg-white/20 border border-white/30 text-white flex items-center gap-2 overflow-hidden clickable">
                                        <div v-if="itinerary[currentDayIndex].accommodation.image" class="w-full h-full absolute inset-0" @click="viewImage(itinerary[currentDayIndex].accommodation.image)">
                                            <img :src="itinerary[currentDayIndex].accommodation.image" class="w-full h-full object-cover">
                                        </div>
                                        <i class="fa-solid fa-paperclip text-xs"></i> <span class="text-[10px] font-bold">è¨‚å–®</span>
                                        <input v-if="!itinerary[currentDayIndex].accommodation.image" type="file" accept="image/*" class="file-input" @change="handleImageUpload($event, itinerary[currentDayIndex].accommodation)">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. æ¸…å–® (List) -->
        <div v-if="currentTab === 'list'" class="px-5 pt-2 flex-1 overflow-y-auto hide-scrollbar">
            <div class="flex p-1.5 bg-white rounded-2xl border-2 border-[#FFCDD2] mb-6 shadow-sm noselect">
                <button @click="listType = 'buy'" :class="listType === 'buy' ? 'bg-[#FF4081] text-white shadow-md' : 'text-[#FF80AB]'" class="flex-1 py-3 rounded-xl text-xs font-bold transition-all">è³¼ç‰©</button>
                <button @click="listType = 'eat'" :class="listType === 'eat' ? 'bg-[#00BCD4] text-white shadow-md' : 'text-[#00BCD4]'" class="flex-1 py-3 rounded-xl text-xs font-bold transition-all">ç¾é£Ÿ</button>
            </div>

            <!-- å¿«é€Ÿé€£çµå€ (é›™åœ°åœ–) -->
            <div class="mb-6 grid grid-cols-1 gap-4">
                <div class="ppg-card p-4 border-[#00BCD4] !border-l-4">
                    <div class="flex items-center justify-between mb-2 noselect">
                        <h3 class="text-sm font-bold text-[#006064]"><i class="fa-solid fa-utensils mr-1"></i> ç¾é£Ÿåœ°åœ–</h3>
                        <button v-if="foodMapUrl" @click="isEditingFood = !isEditingFood" class="text-[10px] text-[#00BCD4] underline">ç·¨è¼¯</button>
                    </div>
                    <div v-if="!foodMapUrl || isEditingFood" class="flex gap-2">
                        <input v-model="tempFoodMapUrl" placeholder="é•·æŒ‰è²¼ä¸Š..." class="flex-1 bg-[#E0F7FA] px-3 py-2 rounded-lg text-xs text-[#006064]">
                        <button @click="saveFoodMap" class="bg-[#00BCD4] text-white px-3 py-2 rounded-lg text-xs font-bold shadow noselect">å­˜</button>
                    </div>
                    <a v-if="foodMapUrl && !isEditingFood" :href="foodMapUrl" target="_blank" class="block w-full bg-[#E0F7FA] text-[#00BCD4] font-bold text-center py-2 rounded-lg text-sm hover:bg-[#B2EBF2] transition noselect">
                        é–‹å•Ÿç¾é£Ÿåœ°åœ– <i class="fa-solid fa-arrow-up-right-from-square text-xs ml-1"></i>
                    </a>
                </div>

                <div class="ppg-card p-4 border-[#FF4081] !border-l-4">
                    <div class="flex items-center justify-between mb-2 noselect">
                        <h3 class="text-sm font-bold text-[#C2185B]"><i class="fa-solid fa-bag-shopping mr-1"></i> è³¼ç‰©åœ°åœ–</h3>
                        <button v-if="shopMapUrl" @click="isEditingShop = !isEditingShop" class="text-[10px] text-[#FF4081] underline">ç·¨è¼¯</button>
                    </div>
                    <div v-if="!shopMapUrl || isEditingShop" class="flex gap-2">
                        <input v-model="tempShopMapUrl" placeholder="é•·æŒ‰è²¼ä¸Š..." class="flex-1 bg-[#FCE4EC] px-3 py-2 rounded-lg text-xs text-[#C2185B]">
                        <button @click="saveShopMap" class="bg-[#FF4081] text-white px-3 py-2 rounded-lg text-xs font-bold shadow noselect">å­˜</button>
                    </div>
                    <a v-if="shopMapUrl && !isEditingShop" :href="shopMapUrl" target="_blank" class="block w-full bg-[#FCE4EC] text-[#C2185B] font-bold text-center py-2 rounded-lg text-sm hover:bg-[#F8BBD0] transition noselect">
                        é–‹å•Ÿè³¼ç‰©åœ°åœ– <i class="fa-solid fa-arrow-up-right-from-square text-xs ml-1"></i>
                    </a>
                </div>
            </div>

            <div v-if="listType === 'buy'" class="flex justify-end mb-3 noselect">
                <button @click="showUncheckedOnly = !showUncheckedOnly" class="text-xs font-bold px-3 py-1.5 rounded-full transition-colors border" :class="showUncheckedOnly ? 'bg-[#FF4081] text-white border-[#FF4081]' : 'text-[#FF80AB] bg-white border-[#FFCDD2]'">åªçœ‹æœªè²·</button>
            </div>

            <div class="ppg-card p-4 mb-6 flex gap-3 items-center border-[#FF4081] !border-l-4">
                <div class="relative w-12 h-12 rounded-xl bg-[#FFF0F5] border-2 border-dashed border-[#FF80AB] flex items-center justify-center text-[#FF80AB] clickable noselect">
                    <img v-if="newItem.image" :src="newItem.image" class="w-full h-full object-cover rounded-xl opacity-80">
                    <i v-else class="fa-solid fa-camera text-lg"></i>
                    <input type="file" accept="image/*" class="file-input" @change="handleImageUpload($event, newItem)">
                </div>
                <div class="flex-1">
                    <div class="flex gap-2 mb-1">
                        <input v-model="newItem.name" placeholder="åç¨±..." class="flex-1 text-sm font-bold text-[#333]">
                        <input v-if="listType === 'eat'" v-model="newItem.category" placeholder="æ¨™ç±¤" class="w-16 bg-[#E0F7FA] text-xs px-2 py-0.5 rounded text-center text-[#00BCD4] font-bold">
                    </div>
                    <input v-model="newItem.note" placeholder="å‚™è¨»..." class="w-full text-xs text-[#FF4081]">
                </div>
                <button @click="addItem" class="w-10 h-10 rounded-full bg-[#FF4081] text-white shadow flex items-center justify-center shrink-0 active:bg-[#F50057] noselect"><i class="fa-solid fa-plus"></i></button>
            </div>

            <div class="space-y-3 pb-20">
                <div v-for="(item, idx) in filteredList" :key="item.id" class="ppg-card p-0 relative overflow-hidden" :class="{'completed-card': item.checked}">
                    <div class="swipe-item">
                        <div class="swipe-content p-4 w-full flex gap-4 items-center">
                            <button @click="toggleCheck(item)" class="text-xl shrink-0 transition-colors check-btn noselect" :class="item.checked ? 'text-white' : 'text-[#FFCDD2]'">
                                <i :class="item.checked ? 'fa-solid fa-circle-check' : 'fa-regular fa-circle'"></i>
                            </button>
                            <div class="relative w-16 h-16 bg-[#FFF0F5] rounded-xl border-2 border-[#FFCDD2] overflow-hidden clickable noselect">
                                <img v-if="item.image" :src="item.image" class="w-full h-full object-cover" @click="viewImage(item.image)">
                                <div v-else class="w-full h-full flex items-center justify-center text-[#FFCDD2]"><i class="fa-solid fa-image"></i></div>
                            </div>
                            <div class="flex-1 py-1 min-w-0">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-base leading-tight mb-1 truncate">{{ item.name }}</h3>
                                    <span v-if="item.category" class="text-[9px] px-2 py-0.5 rounded-full border-2 font-bold whitespace-nowrap ml-2 noselect" :class="item.checked ? 'border-white text-white' : 'border-[#00BCD4] text-[#00BCD4] bg-[#E0F7FA]'">{{ item.category }}</span>
                                </div>
                                <p class="text-xs mb-2 truncate text-secondary">{{ item.note }}</p>
                                <div class="flex gap-2 noselect">
                                    <a v-if="listType === 'eat'" :href="getNearbyLink(item)" target="_blank" class="text-[10px] font-bold px-3 py-1.5 rounded-lg shadow-sm" :class="item.checked ? 'bg-white text-[#00BCD4]' : 'bg-[#00BCD4] text-white'">æœ€è¿‘</a>
                                    <a v-if="listType === 'buy'" :href="getMapLink(item.name)" target="_blank" class="text-[10px] font-bold px-3 py-1.5 rounded-lg" :class="item.checked ? 'bg-white/20 text-white' : 'bg-[#FFF0F5] text-[#FF4081]'">æœå°‹</a>
                                </div>
                            </div>
                        </div>
                        <div class="swipe-action bg-[#FF4081] flex items-center justify-center cursor-pointer noselect" @click="deleteItem(item)"><i class="fa-solid fa-trash text-white text-xl"></i></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. åŒ¯ç‡ (Currency) -->
        <div v-if="currentTab === 'currency'" class="px-5 pt-10 flex-1 overflow-y-auto hide-scrollbar">
            <div class="ppg-card p-8 mb-8 text-center bg-white shadow-xl">
                <div class="text-[10px] tracking-[0.2em] text-[#FF80AB] uppercase mb-2 font-bold noselect">Real-time Rate</div>
                <div class="flex justify-center items-end gap-3 mb-3 pb-6 border-b-2 border-[#FFF0F5]">
                    <span class="text-sm text-[#FF4081] font-bold noselect">Â¥1 =</span>
                    <input type="number" step="0.001" v-model="rate" class="w-32 text-center text-3xl font-black text-[#333] border-b-2 border-[#FFCDD2]">
                    <span class="text-sm text-[#FF4081] font-bold noselect">TWD</span>
                    <button @click="fetchRate" class="ml-2 w-9 h-9 rounded-full bg-[#E0F7FA] text-[#00BCD4] flex items-center justify-center active:bg-cyan-100 noselect"><i class="fa-solid fa-arrows-rotate" :class="{'spin': isLoadingRate}"></i></button>
                </div>
                <div v-if="lastUpdated" class="text-[10px] text-[#4DD0E1] mb-6 flex justify-center items-center gap-1 font-bold noselect"><i class="fa-regular fa-clock"></i> {{ lastUpdated }} (å«2%)</div>
                <div class="space-y-5">
                    <div class="flex gap-4">
                        <div class="flex-1"><label class="text-[10px] text-[#FF80AB] uppercase block mb-1 font-bold noselect">JPY</label><input type="number" v-model="jpyAmount" class="w-full bg-[#FFF0F5] rounded-2xl py-4 text-center text-xl font-bold text-[#333]" placeholder="0"></div>
                        <div class="flex-1"><label class="text-[10px] text-[#FF80AB] uppercase block mb-1 font-bold noselect">TWD</label><div class="bg-[#8BC34A] text-white rounded-2xl py-4 text-center shadow-lg"><span class="text-xl font-bold">{{ Math.round(jpyAmount * rate).toLocaleString() }}</span></div></div>
                    </div>
                    <div class="flex gap-2 items-center">
                        <input type="text" v-model="historyNote" placeholder="å‚™è¨»..." class="flex-1 bg-white border-2 border-[#FFCDD2] rounded-xl px-4 py-3 text-sm text-[#333]">
                        <button @click="addHistory" class="bg-[#FF4081] text-white w-12 h-11 rounded-xl flex items-center justify-center shadow-md active:bg-[#F50057] noselect"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>
            </div>
            <h3 class="text-xs font-bold text-[#FF4081] mb-4 ml-2 uppercase tracking-wide noselect">æ¯”åƒ¹ç´€éŒ„</h3>
            <div class="space-y-3 pb-20">
                <div v-for="(rec, i) in currencyHistory" :key="rec.id" class="ppg-card p-0 overflow-hidden">
                    <div class="swipe-item">
                        <div class="swipe-content p-5 w-full flex justify-between items-center">
                            <div><div class="text-base font-bold text-[#333] mb-0.5">{{ rec.note || 'æœªå‘½å' }}</div><div class="text-[10px] text-[#FF80AB]">{{ rec.date }}</div></div>
                            <div class="text-right"><div class="text-xs text-[#FF80AB] mb-0.5">Â¥ {{ Number(rec.jpy).toLocaleString() }}</div><div class="text-lg font-bold text-[#8BC34A]">NT$ {{ Number(rec.twd).toLocaleString() }}</div></div>
                        </div>
                        <div class="swipe-action bg-[#FF4081] flex items-center justify-center cursor-pointer noselect" @click="deleteHistory(i)"><i class="fa-solid fa-trash text-white"></i></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. åˆ†å¸³ (Split) -->
        <div v-if="currentTab === 'split'" class="px-5 pt-2 flex-1 overflow-y-auto hide-scrollbar">
            <div class="bg-gradient-to-br from-[#4DD0E1] to-[#00ACC1] text-white p-6 rounded-3xl mb-8 shadow-xl noselect">
                <!-- é›™å¹£ç¸½è¦½ -->
                <div class="flex justify-between gap-4">
                    <div class="flex-1 text-center border-r border-white/20">
                        <h3 class="text-[10px] text-white/80 uppercase mb-1 font-bold">Total JPY</h3>
                        <div class="text-2xl font-black">Â¥ {{ totalExpenses.JPY.toLocaleString() }}</div>
                    </div>
                    <div class="flex-1 text-center">
                        <h3 class="text-[10px] text-white/80 uppercase mb-1 font-bold">Total TWD</h3>
                        <div class="text-2xl font-black">NT$ {{ totalExpenses.TWD.toLocaleString() }}</div>
                    </div>
                </div>

                <!-- å¹£åˆ¥åˆ‡æ›æŒ‰éˆ• -->
                <div class="flex justify-center mt-4 mb-2 bg-white/20 p-1 rounded-full w-fit mx-auto">
                    <button @click="splitViewCurrency='JPY'" class="px-4 py-1 rounded-full text-xs font-bold transition-all" :class="splitViewCurrency=='JPY'?'bg-white text-[#00ACC1]':'text-white'">JPY</button>
                    <button @click="splitViewCurrency='TWD'" class="px-4 py-1 rounded-full text-xs font-bold transition-all" :class="splitViewCurrency=='TWD'?'bg-white text-[#00ACC1]':'text-white'">TWD</button>
                </div>

                <div class="space-y-2 mt-2">
                    <div v-for="person in travelers" :key="person" class="flex justify-between items-center text-sm border-b border-white/20 pb-2 last:border-0">
                        <span class="font-bold text-white/90">{{ person }}</span>
                        <span class="font-black" :class="getBalance(person, splitViewCurrency) > 0 ? 'text-[#DCEDC8]' : 'text-[#FFCDD2]'">
                            {{ getBalance(person, splitViewCurrency) > 0 ? 'æ”¶' : 'ä»˜' }} 
                            <span v-if="splitViewCurrency=='TWD'">$</span><span v-else>Â¥</span>{{ Math.abs(getBalance(person, splitViewCurrency)).toLocaleString() }}
                        </span>
                    </div>
                </div>
            </div>

            <div class="ppg-card p-5 mb-6">
                <!-- é¸æ“‡åƒèˆ‡äºº -->
                <div class="mb-4">
                    <label class="text-[10px] font-bold text-[#FF80AB] uppercase mb-2 block">åˆ†æ”¤çµ¦èª°ï¼Ÿ(é»æ“Šåˆ‡æ›)</label>
                    <div class="flex flex-wrap gap-2">
                        <button v-for="p in travelers" :key="p" 
                            @click="toggleSplitter(p)"
                            class="px-3 py-1 rounded-full text-xs font-bold border-2 transition-all noselect"
                            :class="newExpense.splitters.includes(p) ? 'bg-[#8BC34A] text-white border-[#8BC34A]' : 'bg-white text-[#ccc] border-[#eee]'">
                            {{ p }}
                        </button>
                    </div>
                </div>

                <div class="flex gap-3 mb-3">
                    <select v-model="newExpense.payer" class="bg-[#FFF0F5] px-4 py-3 rounded-xl text-sm font-bold text-[#333] w-1/3"><option disabled value="">èª°ä»˜?</option><option v-for="p in travelers" :value="p">{{ p }}</option></select>
                    <!-- é›™å¹£é¸æ“‡ -->
                    <div class="flex-1 flex gap-2">
                        <input type="number" v-model="newExpense.amount" placeholder="é‡‘é¡" class="bg-[#FFF0F5] px-4 py-3 rounded-xl text-sm font-bold text-[#333] w-full">
                        <select v-model="newExpense.currency" class="bg-[#E0F7FA] px-2 rounded-xl text-xs font-bold text-[#00BCD4]"><option value="JPY">Â¥</option><option value="TWD">NT</option></select>
                    </div>
                </div>
                <div class="flex gap-3">
                    <input type="text" v-model="newExpense.desc" placeholder="é …ç›®" class="bg-[#FFF0F5] px-4 py-3 rounded-xl text-sm w-full">
                    <button @click="addExpense" class="bg-[#8BC34A] text-white px-6 rounded-xl shadow-lg active:bg-[#689F38] noselect"><i class="fa-solid fa-plus"></i></button>
                </div>
            </div>
            
            <div class="space-y-3 pb-20">
                <div v-for="(exp, i) in expenses" :key="i" class="bg-white px-6 py-4 rounded-2xl flex justify-between items-center shadow-sm border-2 border-[#F1F8E9]">
                    <div>
                        <div class="text-sm font-bold text-[#333]">{{ exp.desc }}</div>
                        <div class="text-[10px] text-[#8BC34A] mt-0.5 font-bold">
                            {{ exp.payer }} ä»˜ 
                            <span v-if="exp.currency === 'TWD'">NT$ {{ Number(exp.originalAmount).toLocaleString() }}</span>
                            <span v-else>Â¥ {{ Number(exp.originalAmount).toLocaleString() }}</span>
                            <span class="text-[#ccc] font-normal ml-1">({{ exp.splitters ? exp.splitters.length : 'å…¨' }}äººåˆ†)</span>
                        </div>
                    </div>
                    <button @click="expenses.splice(i, 1)" class="text-[#FFCDD2] hover:text-[#FF4081] noselect"><i class="fa-solid fa-trash"></i></button>
                </div>
            </div>
             <div class="mb-6 px-4 py-4 border-2 border-dashed border-[#4DD0E1] rounded-2xl bg-[#E0F7FA]/30"><div class="text-[10px] text-[#00ACC1] uppercase mb-2 font-bold noselect">Travelers</div><input v-model="travelerInput" @blur="updateTravelers" class="w-full bg-transparent font-bold text-[#333]" placeholder="æˆ‘, æœ‹å‹A"></div>
        </div>

        <nav class="fixed bottom-0 w-full glass-nav flex justify-around items-center pt-4 z-50 noselect">
            <button @click="currentTab = 'schedule'" class="group w-1/4 flex flex-col items-center gap-1"><i class="fa-solid fa-map-location text-xl" :class="currentTab === 'schedule' ? 'text-[#FF4081]' : 'text-[#FFCDD2]'"></i><span class="text-[9px] font-bold uppercase">Plan</span></button>
            <button @click="currentTab = 'list'" class="group w-1/4 flex flex-col items-center gap-1"><i class="fa-solid fa-clipboard-check text-xl" :class="currentTab === 'list' ? 'text-[#4DD0E1]' : 'text-[#B2EBF2]'"></i><span class="text-[9px] font-bold uppercase">List</span></button>
            <button @click="currentTab = 'currency'" class="group w-1/4 flex flex-col items-center gap-1"><i class="fa-solid fa-calculator text-xl" :class="currentTab === 'currency' ? 'text-[#8BC34A]' : 'text-[#DCEDC8]'"></i><span class="text-[9px] font-bold uppercase">Rate</span></button>
            <button @click="currentTab = 'split'" class="group w-1/4 flex flex-col items-center gap-1"><i class="fa-solid fa-file-invoice-dollar text-xl" :class="currentTab === 'split' ? 'text-[#333]' : 'text-[#CCC]'"></i><span class="text-[9px] font-bold uppercase">Split</span></button>
        </nav>

        <div v-if="showSettings" class="modal-overlay" @click.self="showSettings = false">
            <div class="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl border-4 border-[#FFCDD2] relative">
                <button @click="showSettings = false" class="absolute top-4 right-4 text-[#FFCDD2] hover:text-[#FF4081] p-2 text-2xl z-50 noselect"><i class="fa-solid fa-times"></i></button>
                <h3 class="text-xl font-black text-[#FF4081] mb-6 noselect">è¨­å®š</h3>
                <div class="mb-6"><label class="text-xs font-bold text-[#FF4081] block mb-2 noselect">å‡ºç™¼æ—¥</label><input type="date" v-model="startDate" class="w-full bg-[#FFF0F5] p-3 rounded-xl font-bold border-2 border-[#FFCDD2]"></div>
                <div class="bg-[#FFF0F5] p-5 rounded-2xl mb-4 border-2 border-[#FFCDD2]">
                    <h4 class="text-sm font-bold text-[#FF4081] mb-3 noselect">å‚™ä»½</h4>
                    <button @click="saveManualBackup" class="w-full bg-[#FF4081] text-white py-3 rounded-xl text-xs font-bold mb-3 shadow-md noselect">ğŸ’¾ å»ºç«‹å‚™ä»½</button>
                    <button @click="loadManualBackup" class="w-full bg-white border-2 border-[#FF4081] text-[#FF4081] py-3 rounded-xl text-xs font-bold mb-3 noselect">ğŸ“‚ é‚„åŸå‚™ä»½</button>
                    <button @click="exportData" class="w-full bg-[#4DD0E1] text-white py-3 rounded-xl text-xs font-bold mb-2 shadow-md noselect">ğŸ“¤ ç”¢ç”Ÿåˆ†äº«ä»£ç¢¼</button>
                    <div class="flex gap-2">
                         <input v-model="importString" placeholder="è²¼ä¸Šä»£ç¢¼..." class="flex-1 bg-white px-3 py-2 rounded-lg text-xs text-[#333] border border-[#FFCDD2]">
                         <button @click="importData" class="bg-[#4DD0E1] text-white px-3 py-2 rounded-lg text-xs font-bold whitespace-nowrap noselect">ğŸ“¥ åŒ¯å…¥</button>
                    </div>
                </div>
                <div class="bg-white border-2 border-[#4DD0E1] p-5 rounded-2xl mb-6">
                    <h4 class="text-sm font-bold text-[#4DD0E1] mb-2 noselect"><i class="fa-solid fa-truck-medical mr-2"></i> è³‡æ–™æ•‘æ´</h4>
                    <button @click="recoverOldData" class="w-full bg-[#4DD0E1] text-white py-3 rounded-xl text-xs font-bold transition shadow-md noselect">ğŸ“‚ å˜—è©¦å¾èˆŠç‰ˆæ•‘æ´è³‡æ–™</button>
                </div>
                <button @click="resetData" class="w-full text-[#FFCDD2] text-xs py-4 font-bold noselect">æ¸…é™¤è³‡æ–™é‡ç½®</button>
            </div>
        </div>

        <div v-if="movingEventIndex !== null" class="modal-overlay" @click.self="movingEventIndex = null">
            <div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl border-4 border-[#4DD0E1]">
                <h3 class="text-lg font-bold text-[#00BCD4] mb-4 text-center">ç§»å‹•åˆ°å“ªä¸€å¤©ï¼Ÿ</h3>
                <div class="grid grid-cols-3 gap-3">
                    <button v-for="(day, idx) in itinerary" :key="idx" @click="confirmMove(idx)" class="bg-[#E0F7FA] text-[#006064] py-3 rounded-xl font-bold text-sm hover:bg-[#4DD0E1] hover:text-white transition">Day {{ idx + 1 }}</button>
                </div>
                <button @click="movingEventIndex = null" class="mt-4 w-full text-[#FFCDD2] font-bold text-xs py-2">å–æ¶ˆ</button>
            </div>
        </div>

        <div v-if="viewingImage" class="modal-overlay" @click.self="viewingImage = null">
            <div class="relative max-w-lg w-full p-4">
                <img :src="viewingImage" class="w-full rounded-2xl shadow-2xl border-4 border-white">
                <button @click="deleteViewingImage" class="absolute bottom-[-60px] left-1/2 transform -translate-x-1/2 bg-[#FF4081] text-white px-8 py-3 rounded-full text-sm shadow-lg font-bold">åˆªé™¤</button>
                <button @click="viewingImage = null" class="absolute -top-12 right-0 text-white text-3xl"><i class="fa-solid fa-times"></i></button>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, watch, onMounted, nextTick } = Vue;

        createApp({
            setup() {
                const currentTab = ref('schedule');
                const showSettings = ref(false);
                const viewingImage = ref(null);
                const movingEventIndex = ref(null);
                const splitViewCurrency = ref('JPY');
                
                const currentDayIndex = ref(0);
                const itinerary = ref([{ events: [{ id: Date.now(), time: '10:00', location: 'æˆç”°æ©Ÿå ´', transport: 'train', note: '', image: null }], accommodation: { name: '', note: '', image: null } }]);
                const startDate = ref('');
                
                const listType = ref('buy');
                const wishlist = ref([]);
                const newItem = ref({ name: '', note: '', category: '', image: null });
                const showUncheckedOnly = ref(false);
                const savedMapUrl = ref(''); const tempMapUrl = ref(''); const isEditingMap = ref(false);
                const foodMapUrl = ref(''); const tempFoodMapUrl = ref(''); const isEditingFood = ref(false);
                const shopMapUrl = ref(''); const tempShopMapUrl = ref(''); const isEditingShop = ref(false);

                const saveFoodMap = () => { if(tempFoodMapUrl.value) { foodMapUrl.value = tempFoodMapUrl.value; isEditingFood.value = false; } };
                const saveShopMap = () => { if(tempShopMapUrl.value) { shopMapUrl.value = tempShopMapUrl.value; isEditingShop.value = false; } };
                const saveMapUrl = () => { if(tempMapUrl.value) { savedMapUrl.value = tempMapUrl.value; isEditingMap.value = false; } };

                const rate = ref(0.215);
                const jpyAmount = ref('');
                const isLoadingRate = ref(false);
                const lastUpdated = ref('');
                const historyNote = ref('');
                const currencyHistory = ref([]);

                const travelerInput = ref('æˆ‘, æ—…ä¼´');
                const expenses = ref([]);
                const newExpense = ref({ payer: '', amount: '', desc: '', currency: 'JPY', splitters: [] });
                const importString = ref('');

                const travelers = computed(() => travelerInput.value.split(/[,ï¼Œ]/).map(t => t.trim()).filter(t => t));
                const filteredList = computed(() => {
                    let list = wishlist.value.filter(item => item.type === listType.value);
                    if (listType.value === 'buy' && showUncheckedOnly.value) return list.filter(item => !item.checked);
                    return list;
                });
                
                const totalExpenses = computed(() => {
                    let jpy = 0;
                    let twd = 0;
                    expenses.value.forEach(e => {
                        if (e.currency === 'TWD') twd += Number(e.originalAmount);
                        else jpy += Number(e.originalAmount);
                    });
                    return { JPY: jpy, TWD: twd };
                });

                // Init splitters
                watch(travelers, (newVal) => {
                    if(newExpense.value.splitters.length === 0) newExpense.value.splitters = [...newVal];
                }, { immediate: true });

                const addDay = () => itinerary.value.push({ events: [], accommodation: { name: '', note: '', image: null } });
                const addEvent = () => itinerary.value[currentDayIndex.value].events.push({ id: Date.now(), time: '12:00', location: '', transport: 'walk', note: '', image: null });
                const removeEvent = (idx) => itinerary.value[currentDayIndex.value].events.splice(idx, 1);
                
                const openMoveModal = (idx) => { movingEventIndex.value = idx; };
                const confirmMove = (targetDayIdx) => {
                    if (movingEventIndex.value !== null) {
                        const event = itinerary.value[currentDayIndex.value].events.splice(movingEventIndex.value, 1)[0];
                        itinerary.value[targetDayIdx].events.push(event);
                        movingEventIndex.value = null;
                        alert('ç§»å‹•æˆåŠŸï¼');
                    }
                };

                const copyFromPreviousDay = () => {
                    if (currentDayIndex.value > 0) {
                        const prevHotel = itinerary.value[currentDayIndex.value - 1].accommodation;
                        const currHotel = itinerary.value[currentDayIndex.value].accommodation;
                        currHotel.name = prevHotel.name;
                        currHotel.note = prevHotel.note;
                        currHotel.image = prevHotel.image;
                        alert('å·²è¤‡è£½ï¼');
                    }
                };
                
                const changeDay = (index) => { currentDayIndex.value = index; nextTick(() => initSortable()); };
                let sortableInstance = null;
                const initSortable = () => {
                    const el = document.getElementById('sortable-list');
                    if (el && typeof Sortable !== 'undefined') {
                        if (sortableInstance) sortableInstance.destroy();
                        sortableInstance = new Sortable(el, { handle: '.drag-handle', animation: 150, onEnd: (evt) => { const item = itinerary.value[currentDayIndex.value].events.splice(evt.oldIndex, 1)[0]; itinerary.value[currentDayIndex.value].events.splice(evt.newIndex, 0, item); } });
                    }
                };

                const getMapLink = (loc) => loc ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}` : '#';
                const getDailyRouteLink = () => {
                    const locs = itinerary.value[currentDayIndex.value].events.map(e => e.location).filter(l => l);
                    return locs.length > 1 ? `https://www.google.com/maps/dir/${locs.map(l => encodeURIComponent(l)).join('/')}` : '#';
                };
                const getRouteLink = (curr, next) => {
                    if(!curr.location || !next.location) return '#';
                    return `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(curr.location)}&destination=${encodeURIComponent(next.location)}`;
                };
                const getFullDayDate = (dayIndex) => {
                     if (!startDate.value) return '';
                     const date = new Date(startDate.value);
                     date.setDate(date.getDate() + dayIndex);
                     const weekDays = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
                     return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()} (${weekDays[date.getDay()]})`;
                };
                const getDayDate = (dayIndex) => {
                     if (!startDate.value) return '';
                     const date = new Date(startDate.value);
                     date.setDate(date.getDate() + dayIndex);
                     return `${date.getMonth() + 1}/${date.getDate()}`;
                };

                const handleImageUpload = (event, target) => {
                    const file = event.target.files[0];
                    if(!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            const scale = 600 / img.width;
                            canvas.width = 600; canvas.height = img.height * scale;
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            target.image = canvas.toDataURL('image/jpeg', 0.7);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                };
                
                const addItem = () => { if(newItem.value.name) { wishlist.value.unshift({ id: Date.now(), type: listType.value, name: newItem.value.name, note: newItem.value.note, category: newItem.value.category, image: newItem.value.image, checked: false }); newItem.value = { name: '', note: '', category: '', image: null }; } };
                const deleteItem = (item) => { const idx = wishlist.value.indexOf(item); if(idx > -1) wishlist.value.splice(idx, 1); };
                const toggleCheck = (item) => item.checked = !item.checked;
                const viewImage = (src) => viewingImage.value = src;
                const deleteViewingImage = () => {
                     const src = viewingImage.value;
                     itinerary.value.forEach(d => { d.events.forEach(e => { if(e.image===src) e.image=null; }); if(d.accommodation.image===src) d.accommodation.image=null; });
                     wishlist.value.forEach(w => { if(w.image===src) w.image=null; });
                     viewingImage.value = null;
                };

                const getNearbyLink = (item) => { const query = item.category ? `${item.name} ${item.category}` : item.name; return `https://www.google.com/maps/search/${encodeURIComponent(query + ' near me')}`; };

                const fetchRate = async () => {
                    isLoadingRate.value = true;
                    try { const res = await fetch('https://open.er-api.com/v6/latest/JPY'); const data = await res.json(); rate.value = (data.rates.TWD * 1.02).toFixed(3); lastUpdated.value = new Date().toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit'}); } catch(e) { alert('æ›´æ–°å¤±æ•—'); } finally { isLoadingRate.value = false; }
                };
                const addHistory = () => { if(!jpyAmount.value) return; currencyHistory.value.unshift({ id: Date.now(), jpy: jpyAmount.value, twd: Math.round(jpyAmount.value * rate.value), note: historyNote.value, date: new Date().toLocaleDateString() }); historyNote.value = ''; };
                const deleteHistory = (idx) => currencyHistory.value.splice(idx, 1);

                const addExpense = () => {
                    if (newExpense.value.amount && newExpense.value.splitters.length > 0) {
                        expenses.value.unshift({ 
                            ...newExpense.value, 
                            splitters: [...newExpense.value.splitters], 
                            originalAmount: newExpense.value.amount 
                        });
                        newExpense.value.amount=''; newExpense.value.desc='';
                    } else { alert('è«‹è¼¸å…¥é‡‘é¡ä¸¦è‡³å°‘é¸æ“‡ä¸€ä½åˆ†æ”¤äºº'); }
                };

                const getBalance = (person, viewCurrency) => {
                    let totalPaid = 0;
                    let totalShouldPay = 0;
                    expenses.value.forEach(exp => {
                        if (exp.currency === viewCurrency) {
                            if (exp.payer === person) totalPaid += Number(exp.originalAmount);
                            if (exp.splitters.includes(person)) totalShouldPay += (Number(exp.originalAmount) / exp.splitters.length);
                        }
                    });
                    return Math.round(totalPaid - totalShouldPay);
                };

                const updateTravelers = () => {};

                const saveManualBackup = () => { const data = { itinerary: itinerary.value, wishlist: wishlist.value, rate: rate.value, expenses: expenses.value, travelerInput: travelerInput.value, lastUpdated: lastUpdated.value, currencyHistory: currencyHistory.value, foodMapUrl: foodMapUrl.value, shopMapUrl: shopMapUrl.value, startDate: startDate.value }; try { localStorage.setItem('tokyoTrip_ManualBackup', JSON.stringify(data)); alert('å‚™ä»½æˆåŠŸ'); } catch(e) { alert('å‚™ä»½å¤±æ•—(ç©ºé–“ä¸è¶³)'); } };
                const loadManualBackup = () => { const backup = localStorage.getItem('tokyoTrip_ManualBackup'); if(backup && confirm('é‚„åŸå‚™ä»½ï¼Ÿ')) { const data = JSON.parse(backup); itinerary.value = data.itinerary; wishlist.value = data.wishlist; rate.value = data.rate; expenses.value = data.expenses; travelerInput.value = data.travelerInput; lastUpdated.value = data.lastUpdated; currencyHistory.value = data.currencyHistory; foodMapUrl.value = data.foodMapUrl; shopMapUrl.value = data.shopMapUrl; startDate.value = data.startDate; alert('æˆåŠŸ'); nextTick(() => initSortable()); } else if(!backup) { alert('ç„¡å‚™ä»½'); } };
                const resetData = () => { if(confirm('è­¦å‘Šï¼šåˆªé™¤æ‰€æœ‰è³‡æ–™ï¼')) { localStorage.removeItem('tokyoTrip_V47_Safe'); location.reload(); } };

                const recoverOldData = () => {
                    const legacyKeys = ['tokyoTrip_V46_Final', 'tokyoTrip_V45_Final', 'tokyoTrip_V44_Final'];
                    let found = false;
                    for (const key of legacyKeys) {
                        const old = localStorage.getItem(key);
                        if (old) { 
                            if(confirm(`ç™¼ç¾èˆŠè³‡æ–™ (${key})ï¼Œè¦è¼‰å…¥å—ï¼Ÿ`)) {
                                const data = JSON.parse(old);
                                itinerary.value = data.itinerary; wishlist.value = data.wishlist; rate.value = data.rate; expenses.value = data.expenses; travelerInput.value = data.travelerInput; lastUpdated.value = data.lastUpdated; currencyHistory.value = data.currencyHistory; 
                                foodMapUrl.value = data.foodMapUrl || ''; shopMapUrl.value = data.shopMapUrl || ''; startDate.value = data.startDate;
                                found = true; break; 
                            }
                        }
                    }
                    if(!found) alert('æœªç™¼ç¾èˆŠè³‡æ–™');
                };

                const exportData = () => {
                    const data = JSON.stringify({ itinerary: itinerary.value, wishlist: wishlist.value, rate: rate.value, expenses: expenses.value, travelerInput: travelerInput.value, foodMapUrl: foodMapUrl.value, shopMapUrl: shopMapUrl.value, startDate: startDate.value });
                    const encoded = btoa(unescape(encodeURIComponent(data)));
                    navigator.clipboard.writeText(encoded).then(() => alert('ä»£ç¢¼å·²è¤‡è£½ï¼è«‹å‚³çµ¦æœ‹å‹'));
                };
                const importData = () => {
                    if(!importString.value) return;
                    try {
                        const decoded = decodeURIComponent(escape(atob(importString.value)));
                        const data = JSON.parse(decoded);
                        if(confirm('ç¢ºå®šåŒ¯å…¥æœ‹å‹çš„è¡Œç¨‹ï¼Ÿ')) {
                            itinerary.value = data.itinerary; wishlist.value = data.wishlist; expenses.value = data.expenses; travelerInput.value = data.travelerInput; foodMapUrl.value = data.foodMapUrl; shopMapUrl.value = data.shopMapUrl; startDate.value = data.startDate;
                            alert('åŒ¯å…¥æˆåŠŸï¼'); showSettings.value = false; importString.value = '';
                            nextTick(() => initSortable());
                        }
                    } catch (e) { alert('ä»£ç¢¼éŒ¯èª¤'); }
                };

                const KEY = 'tokyoTrip_V47_Safe';
                onMounted(() => {
                    document.getElementById('panic-btn').style.display = 'none';
                    const saved = localStorage.getItem(KEY);
                    if(saved) {
                        try {
                            const data = JSON.parse(saved);
                            itinerary.value = data.itinerary; wishlist.value = data.wishlist; rate.value = data.rate; expenses.value = data.expenses; travelerInput.value = data.travelerInput; lastUpdated.value = data.lastUpdated; currencyHistory.value = data.currencyHistory; foodMapUrl.value = data.foodMapUrl; shopMapUrl.value = data.shopMapUrl; startDate.value = data.startDate;
                        } catch(e) { console.log('Reset'); }
                    }
                    nextTick(() => initSortable());
                });

                watch([itinerary, wishlist, rate, expenses, travelerInput, lastUpdated, currencyHistory, foodMapUrl, shopMapUrl, startDate], () => {
                    try { localStorage.setItem(KEY, JSON.stringify({ itinerary: itinerary.value, wishlist: wishlist.value, rate: rate.value, expenses: expenses.value, travelerInput: travelerInput.value, lastUpdated: lastUpdated.value, currencyHistory: currencyHistory.value, foodMapUrl: foodMapUrl.value, shopMapUrl: shopMapUrl.value, startDate: startDate.value })); } catch(e) {}
                }, { deep: true });

                return {
                    currentTab, showSettings, viewingImage, movingEventIndex,
                    currentDayIndex, itinerary, addDay, addEvent, removeEvent, changeDay,
                    getMapLink, getDailyRouteLink, getRouteLink,
                    listType, wishlist, newItem, addItem, deleteItem, filteredList,
                    handleImageUpload, viewImage, deleteViewingImage, getNearbyLink,
                    foodMapUrl, shopMapUrl, tempFoodMapUrl, tempShopMapUrl, isEditingFood, isEditingShop, saveFoodMap, saveShopMap, showUncheckedOnly,
                    rate, jpyAmount, fetchRate, isLoadingRate, lastUpdated, historyNote, currencyHistory, addHistory, deleteHistory,
                    travelerInput, travelers, expenses, newExpense, addExpense, totalExpenses, getBalance, updateTravelers,
                    resetData, saveManualBackup, loadManualBackup, startDate, getFullDayDate, getDayDate,
                    recoverOldData, exportData, importData, importString,
                    openMoveModal, confirmMove, copyFromPreviousDay,
                    splitViewCurrency, toggleSplitter
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
