<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Tokyo Trip V34</title>
    
    <!-- å¼•å…¥åœ–ç¤ºåº« (é€™æ˜¯å”¯ä¸€ä¿ç•™çš„å¤–éƒ¨ä¾è³´ï¼Œé€šå¸¸å¾ˆç©©) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- V34 æ‰‹å¯«åŸç”Ÿ CSS (ä¸ä¾è³´ Tailwind) --- */
        
        /* 1. è®Šæ•¸è¨­å®š (é£›å¤©å°å¥³è­¦é…è‰²) */
        :root {
            --bg-color: #FFF0F5;
            --primary: #333333;
            --pink: #FF4081;       /* èŠ±èŠ± */
            --blue: #00BCD4;       /* æ³¡æ³¡ */
            --green: #8BC34A;      /* æ¯›æ¯› */
            --white: #FFFFFF;
            --gray-light: #F0F0F0;
            --shadow: 0 4px 12px rgba(255, 64, 129, 0.15);
        }

        /* 2. å…¨åŸŸè¨­å®š */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--primary);
            padding-bottom: 120px; /* é¿é–‹åº•éƒ¨å°èˆª */
            padding-top: env(safe-area-inset-top);
        }

        /* 3. æ’ç‰ˆå·¥å…· */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: 8px; }
        .gap-4 { gap: 16px; }
        .w-full { width: 100%; }
        .text-center { text-align: center; }
        .hidden { display: none !important; }

        /* 4. å…ƒä»¶æ¨£å¼ */
        
        /* å¡ç‰‡ */
        .card {
            background: var(--white);
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
            border: 3px solid white;
            position: relative;
        }
        
        /* ç¶ åº•å®Œæˆå¡ç‰‡ */
        .card.completed {
            background: var(--green);
            color: white;
            border-color: var(--green);
        }
        .card.completed input, .card.completed i { color: white !important; }
        .card.completed .text-sub { color: rgba(255,255,255,0.8); }

        /* ä½å®¿å¡ç‰‡ */
        .card.hotel {
            background: linear-gradient(135deg, #FF4081 0%, #F50057 100%);
            color: white;
            margin-top: 20px;
            border-top: 2px solid #FFCDD2;
        }
        .card.hotel input { color: white; }
        .card.hotel input::placeholder { color: rgba(255,255,255,0.5); }

        /* è¼¸å…¥æ¡† */
        input, select {
            border: none; outline: none; background: transparent;
            font-size: 16px; font-weight: bold; width: 100%;
            color: var(--primary);
        }
        input::placeholder { color: #FFCDD2; font-weight: normal; }
        
        /* æŒ‰éˆ• */
        .btn {
            border: none; padding: 10px 20px; border-radius: 12px;
            font-weight: bold; font-size: 12px; cursor: pointer;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); }
        .btn-pink { background: var(--pink); color: white; }
        .btn-blue { background: var(--blue); color: white; }
        .btn-green { background: var(--green); color: white; }
        .btn-outline { background: white; border: 2px solid var(--pink); color: var(--pink); }
        .btn-icon { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; padding: 0; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* å°èˆªåˆ— */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0,0,0,0.05);
            display: flex; justify-content: space-around;
            padding: 10px 0 calc(10px + env(safe-area-inset-bottom)) 0;
            z-index: 50;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            color: #ccc; font-size: 10px; font-weight: bold;
            background: none; border: none; width: 25%;
        }
        .nav-item.active { color: var(--pink); transform: scale(1.1); }
        .nav-item i { font-size: 20px; margin-bottom: 4px; }

        /* å¤©æ•¸é¸æ“‡å™¨ */
        .day-scroller { display: flex; overflow-x: auto; gap: 10px; padding: 5px; margin-bottom: 10px; }
        .day-btn {
            background: white; border: 1px solid #FFCDD2; color: var(--pink);
            padding: 10px 20px; border-radius: 15px; white-space: nowrap;
            font-weight: bold; font-size: 12px;
        }
        .day-btn.active { background: var(--pink); color: white; border-color: var(--pink); box-shadow: 0 4px 10px rgba(255, 64, 129, 0.3); }

        /* åœ–ç‰‡ç¸®åœ– */
        .thumb {
            width: 40px; height: 40px; border-radius: 50%;
            background: #FFF0F5; border: 2px solid #FFCDD2;
            overflow: hidden; display: flex; align-items: center; justify-content: center;
            color: #FFCDD2; position: relative;
        }
        .thumb img { width: 100%; height: 100%; object-fit: cover; }
        .file-input { position: absolute; width: 100%; height: 100%; opacity: 0; left: 0; top: 0; }

        /* Modal */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 100;
            display: flex; justify-content: center; items-center; padding: 20px;
        }
        .modal-content {
            background: white; width: 100%; max-width: 320px;
            padding: 20px; border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
        }

        /* éŒ¯èª¤è¨Šæ¯ç›’ */
        #error-msg {
            display: none; background: #333; color: #ff5555;
            padding: 15px; font-size: 12px; margin: 10px; border-radius: 8px;
        }
    </style>
</head>
<body>

    <!-- éŒ¯èª¤é¡¯ç¤ºå€ -->
    <div id="error-msg"></div>

    <div id="app">
        <!-- é ‚éƒ¨ -->
        <header style="padding: 20px 20px 10px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: rgba(255,240,245,0.9); z-index: 40;">
            <div>
                <h1 style="font-size: 24px; font-weight: 900; color: var(--pink);">TOKYO <i class="fa-solid fa-heart" style="color: var(--blue);"></i></h1>
            </div>
            <button class="btn-icon" @click="showSettings = true">
                <i class="fa-solid fa-gear" style="color: var(--pink);"></i>
            </button>
        </header>

        <!-- 1. è¡Œç¨‹è¡¨ -->
        <div v-if="currentTab === 'schedule'" style="padding: 0 20px 20px 20px; flex: 1; overflow-y: auto;">
            <!-- å¤©æ•¸ -->
            <div class="flex items-center" style="margin-bottom: 15px;">
                <div class="day-scroller" style="flex: 1;">
                    <button v-for="(day, index) in itinerary" :key="index" @click="currentDayIndex = index" class="day-btn" :class="{active: currentDayIndex === index}">
                        Day {{ index + 1 }}
                    </button>
                    <button class="day-btn" @click="addDay">+</button>
                </div>
                <a :href="getDailyRouteLink()" target="_blank" class="btn-icon" style="border-radius: 12px; margin-left: 5px; background: white; border: 2px solid #E0F7FA;">
                    <i class="fa-solid fa-map" style="color: var(--blue);"></i>
                </a>
            </div>

            <!-- åˆ—è¡¨ -->
            <div class="flex-col gap-4">
                <div v-for="(event, idx) in itinerary[currentDayIndex].events" :key="event.id" class="card">
                    <!-- åˆªé™¤éˆ• -->
                    <button @click="removeEvent(idx)" style="position: absolute; top: 10px; right: 10px; background: none; border: none; color: #FFCDD2;">
                        <i class="fa-solid fa-times"></i>
                    </button>

                    <div class="flex gap-4">
                        <!-- å·¦å´æ™‚é–“ -->
                        <div class="flex-col items-center" style="width: 50px;">
                            <input type="time" v-model="event.time" style="font-size: 12px; background: #FFF0F5; padding: 4px; border-radius: 4px; text-align: center;">
                            <select v-model="event.transport" style="margin-top: 8px; font-size: 18px; text-align: center;">
                                <option value="train">ğŸš‡</option><option value="walk">ğŸš¶</option><option value="taxi">ğŸš•</option><option value="bus">ğŸšŒ</option>
                            </select>
                        </div>
                        
                        <!-- å³å´å…§å®¹ -->
                        <div style="flex: 1; padding-right: 20px;">
                            <input type="text" v-model="event.location" placeholder="åœ°é»..." style="font-size: 18px; margin-bottom: 4px;">
                            <input type="text" v-model="event.note" placeholder="å‚™è¨»" style="font-size: 12px; color: var(--pink); margin-bottom: 8px;">
                            
                            <div class="flex items-center gap-2">
                                <a :href="getMapLink(event.location)" target="_blank" class="btn btn-blue" style="padding: 4px 10px; font-size: 10px;">å°èˆª</a>
                                <div class="thumb">
                                    <img v-if="event.image" :src="event.image" @click="viewImage(event.image)">
                                    <i v-else class="fa-solid fa-camera"></i>
                                    <input type="file" class="file-input" accept="image/*" @change="e => handleImageUpload(e, event)">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è·¯ç·šé€£çµ -->
                    <div v-if="idx < itinerary[currentDayIndex].events.length - 1" style="text-align: center; margin-top: -10px; margin-bottom: -10px; position: relative; z-index: 1;">
                        <a :href="getRouteLink(event, itinerary[currentDayIndex].events[idx+1])" target="_blank" style="background: white; border: 2px solid var(--blue); color: var(--blue); padding: 4px 12px; border-radius: 20px; font-size: 10px; text-decoration: none; font-weight: bold;">
                            â†“ è·¯ç·š
                        </a>
                    </div>
                </div>
            </div>

            <button class="btn btn-outline w-full" style="margin-top: 20px; border-style: dashed;" @click="addEvent">+ æ–°å¢è¡Œç¨‹</button>

            <!-- ä½å®¿ -->
            <div class="card hotel">
                <div class="flex items-center gap-4">
                    <i class="fa-solid fa-hotel" style="font-size: 20px;"></i>
                    <div style="flex: 1;">
                        <input v-model="itinerary[currentDayIndex].accommodation.name" placeholder="ä»Šæ™šä½å“ª?" style="color: white;">
                        <input v-model="itinerary[currentDayIndex].accommodation.note" placeholder="è¨‚æˆ¿ä»£è™Ÿ" style="font-size: 12px; color: rgba(255,255,255,0.7);">
                    </div>
                    <div class="thumb" style="border-color: rgba(255,255,255,0.3); background: rgba(255,255,255,0.1);">
                        <img v-if="itinerary[currentDayIndex].accommodation.image" :src="itinerary[currentDayIndex].accommodation.image" @click="viewImage(itinerary[currentDayIndex].accommodation.image)">
                        <i v-else class="fa-solid fa-paperclip" style="color: white;"></i>
                        <input type="file" class="file-input" accept="image/*" @change="e => handleImageUpload(e, itinerary[currentDayIndex].accommodation)">
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. æ¸…å–® (List) -->
        <div v-if="currentTab === 'list'" style="padding: 20px;">
            <div class="flex gap-2 mb-4">
                <button class="btn w-full" :class="listType==='buy'?'btn-pink':'btn-outline'" @click="listType='buy'">è³¼ç‰©</button>
                <button class="btn w-full" :class="listType==='eat'?'btn-blue':'btn-outline'" @click="listType='eat'" style="border-color: var(--blue); color: var(--blue);" :style="listType==='eat'? 'color:white':''">ç¾é£Ÿ</button>
            </div>

            <!-- è¼¸å…¥æ¡† -->
            <div class="card flex items-center gap-2" style="border-left: 4px solid var(--pink);">
                <div class="thumb">
                    <img v-if="newItem.image" :src="newItem.image">
                    <i v-else class="fa-solid fa-camera"></i>
                    <input type="file" class="file-input" accept="image/*" @change="e => handleImageUpload(e, newItem)">
                </div>
                <div style="flex: 1;">
                    <input v-model="newItem.name" placeholder="æ–°å¢é …ç›®...">
                    <input v-model="newItem.note" placeholder="å‚™è¨»" style="font-size: 12px; color: #999;">
                </div>
                <button class="btn-icon" @click="addItem" style="background: var(--pink); color: white;"><i class="fa-solid fa-plus"></i></button>
            </div>

            <!-- åˆ—è¡¨ -->
            <div v-for="(item, idx) in filteredList" :key="item.id" class="card flex items-center gap-3" :class="{completed: item.checked}">
                <button @click="item.checked = !item.checked" style="background: none; border: none; font-size: 20px; color: #ddd;" :style="item.checked ? 'color: white' : ''">
                    <i :class="item.checked ? 'fa-solid fa-square-check' : 'fa-regular fa-square'"></i>
                </button>
                <div class="thumb" style="border-radius: 8px;">
                    <img v-if="item.image" :src="item.image" @click="viewImage(item.image)">
                    <i v-else class="fa-solid fa-image"></i>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: bold; font-size: 16px;">{{ item.name }}</div>
                    <div class="text-sub" style="font-size: 12px; color: #999;">{{ item.note }}</div>
                </div>
                <button @click="deleteItem(item)" style="background: none; border: none; color: #ffadad;"><i class="fa-solid fa-trash"></i></button>
            </div>
        </div>

        <!-- 3. åŒ¯ç‡ -->
        <div v-if="currentTab === 'currency'" style="padding: 20px;">
            <div class="card text-center" style="padding: 30px;">
                <div style="font-size: 12px; color: var(--pink); font-weight: bold; margin-bottom: 10px;">RATE (å«æ‰‹çºŒè²»)</div>
                <div class="flex justify-center items-end gap-2" style="margin-bottom: 20px;">
                    <span>Â¥1 =</span>
                    <input type="number" step="0.001" v-model="rate" style="width: 80px; text-align: center; border-bottom: 2px solid var(--pink); font-size: 24px;">
                    <span>TWD</span>
                    <button class="btn-icon" @click="fetchRate" style="width: 30px; height: 30px; font-size: 12px; color: var(--blue); background: #E0F7FA;"><i class="fa-solid fa-arrows-rotate"></i></button>
                </div>
                <div class="flex gap-4">
                    <div style="flex: 1;">
                        <div style="font-size: 10px; color: #999;">JPY</div>
                        <input type="number" v-model="jpyAmount" placeholder="0" style="background: #FFF0F5; padding: 10px; border-radius: 10px; text-align: center;">
                    </div>
                    <div style="flex: 1;">
                        <div style="font-size: 10px; color: #999;">TWD</div>
                        <div style="background: var(--green); color: white; padding: 10px; border-radius: 10px; font-weight: bold; font-size: 18px;">
                            {{ Math.round(jpyAmount * rate).toLocaleString() }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. åˆ†å¸³ -->
        <div v-if="currentTab === 'split'" style="padding: 20px;">
            <div class="card" style="background: linear-gradient(135deg, var(--blue), #00ACC1); color: white;">
                <div style="font-size: 12px; opacity: 0.8;">å¹³å‡æ¯äººæ‡‰ä»˜</div>
                <div style="font-size: 32px; font-weight: 900; margin-bottom: 10px;">Â¥ {{ Math.round(totalExpense / travelers.length || 0).toLocaleString() }}</div>
                <div v-for="p in travelers" :key="p" class="flex justify-between" style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 5px; margin-top: 5px; font-size: 14px;">
                    <span>{{ p }}</span>
                    <span>{{ getBalance(p) > 0 ? 'æ”¶' : 'ä»˜' }} {{ Math.abs(getBalance(person)).toLocaleString() }}</span>
                </div>
            </div>
            <div class="card">
                <div class="flex gap-2 mb-2">
                    <select v-model="newExpense.payer" style="background: #F0F0F0; border-radius: 8px; padding: 5px;"><option disabled value="">èª°ä»˜?</option><option v-for="p in travelers" :value="p">{{ p }}</option></select>
                    <input type="number" v-model="newExpense.amount" placeholder="é‡‘é¡" style="background: #F0F0F0; border-radius: 8px; padding: 5px;">
                </div>
                <div class="flex gap-2">
                    <input type="text" v-model="newExpense.desc" placeholder="é …ç›®" style="background: #F0F0F0; border-radius: 8px; padding: 5px;">
                    <button class="btn btn-green" @click="addExpense">+</button>
                </div>
            </div>
            <div v-for="(exp, i) in expenses" :key="i" class="card flex justify-between items-center" style="padding: 10px;">
                <div><div style="font-weight: bold;">{{ exp.desc }}</div><div style="font-size: 10px; color: var(--green);">{{ exp.payer }} å…ˆä»˜</div></div>
                <div class="flex items-center gap-2">
                    <b>Â¥{{ exp.amount }}</b>
                    <button @click="expenses.splice(i, 1)" style="border: none; background: none; color: #ccc;"><i class="fa-solid fa-trash"></i></button>
                </div>
            </div>
            <div style="margin-top: 20px; padding: 10px; border: 2px dashed #ddd; border-radius: 10px;">
                <div style="font-size: 10px; color: #aaa;">æ—…ä¼´ (é€—è™Ÿåˆ†éš”)</div>
                <input v-model="travelerInput" @blur="updateTravelers">
            </div>
        </div>

        <!-- å°èˆªåˆ— -->
        <nav class="nav-bar">
            <button class="nav-item" :class="{active: currentTab === 'schedule'}" @click="currentTab='schedule'"><i class="fa-solid fa-map-location"></i>Plan</button>
            <button class="nav-item" :class="{active: currentTab === 'list'}" @click="currentTab='list'"><i class="fa-solid fa-clipboard-check"></i>List</button>
            <button class="nav-item" :class="{active: currentTab === 'currency'}" @click="currentTab='currency'"><i class="fa-solid fa-calculator"></i>Rate</button>
            <button class="nav-item" :class="{active: currentTab === 'split'}" @click="currentTab='split'"><i class="fa-solid fa-file-invoice-dollar"></i>Split</button>
        </nav>

        <!-- è¨­å®š Modal -->
        <div v-if="showSettings" class="modal" @click.self="showSettings=false">
            <div class="modal-content">
                <h3>è¨­å®š</h3>
                <p style="font-size: 12px; color: #999; margin-bottom: 20px;">V34 åŸç”Ÿç‰ˆ</p>
                <button class="btn w-full" style="color: #ff5555; border: 1px solid #ff5555; background: white;" @click="resetData">æ¸…é™¤æ‰€æœ‰è³‡æ–™é‡ç½®</button>
            </div>
        </div>

        <!-- åœ–ç‰‡ Modal -->
        <div v-if="viewingImage" class="modal" @click.self="viewingImage=null">
            <div class="modal-content">
                <img :src="viewingImage" style="width: 100%; border-radius: 10px;">
                <button class="btn btn-pink w-full" style="margin-top: 10px;" @click="deleteViewingImage">åˆªé™¤ç…§ç‰‡</button>
            </div>
        </div>

    </div>

    <!-- 3. ES Module é‚è¼¯ (ç¾ä»£ç€è¦½å™¨åŸç”Ÿæ”¯æ´) -->
    <script type="module">
        import { createApp, ref, computed, watch, onMounted, nextTick } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';

        createApp({
            setup() {
                const currentTab = ref('schedule');
                const showSettings = ref(false);
                const viewingImage = ref(null);
                
                // Data
                const currentDayIndex = ref(0);
                const itinerary = ref([{ events: [{ id: Date.now(), time: '10:00', location: 'æˆç”°æ©Ÿå ´', transport: 'train', note: '', image: null }], accommodation: { name: '', note: '', image: null } }]);
                const listType = ref('buy');
                const wishlist = ref([]);
                const newItem = ref({ name: '', note: '', image: null });
                const rate = ref(0.215);
                const jpyAmount = ref('');
                const travelerInput = ref('æˆ‘, æ—…ä¼´');
                const expenses = ref([]);
                const newExpense = ref({ payer: '', amount: '', desc: '' });

                // Computed
                const travelers = computed(() => travelerInput.value.split(/[,ï¼Œ]/).map(t => t.trim()).filter(t => t));
                const filteredList = computed(() => wishlist.value.filter(item => item.type === listType.value));
                const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + Number(item.amount), 0));

                // Methods
                const addDay = () => itinerary.value.push({ events: [], accommodation: { name: '', note: '', image: null } });
                const addEvent = () => itinerary.value[currentDayIndex.value].events.push({ id: Date.now(), time: '12:00', location: '', transport: 'walk', note: '', image: null });
                const removeEvent = (idx) => itinerary.value[currentDayIndex.value].events.splice(idx, 1);
                
                const getMapLink = (loc) => loc ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}` : '#';
                const getDailyRouteLink = () => {
                    const locs = itinerary.value[currentDayIndex.value].events.map(e => e.location).filter(l => l);
                    return locs.length > 1 ? `https://www.google.com/maps/dir/${locs.map(l => encodeURIComponent(l)).join('/')}` : '#';
                };
                const getRouteLink = (curr, next) => {
                    if(!curr.location || !next.location) return '#';
                    return `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(curr.location)}&destination=${encodeURIComponent(next.location)}`;
                };

                const addItem = () => { if(newItem.value.name) { wishlist.value.unshift({ id: Date.now(), type: listType.value, name: newItem.value.name, note: newItem.value.note, image: newItem.value.image, checked: false }); newItem.value = { name: '', note: '', image: null }; } };
                const deleteItem = (item) => { const idx = wishlist.value.indexOf(item); if(idx > -1) wishlist.value.splice(idx, 1); };
                
                const handleImageUpload = (event, target) => {
                    const file = event.target.files[0];
                    if(!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            const scale = 500 / img.width;
                            canvas.width = 500; canvas.height = img.height * scale;
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            target.image = canvas.toDataURL('image/jpeg', 0.6);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                };

                const viewImage = (src) => viewingImage.value = src;
                const deleteViewingImage = () => {
                    // Simple delete logic
                    const src = viewingImage.value;
                    itinerary.value.forEach(d => { d.events.forEach(e => { if(e.image===src) e.image=null; }); if(d.accommodation.image===src) d.accommodation.image=null; });
                    wishlist.value.forEach(w => { if(w.image===src) w.image=null; });
                    viewingImage.value = null;
                };

                const fetchRate = async () => {
                    try { const res = await fetch('https://open.er-api.com/v6/latest/JPY'); const data = await res.json(); rate.value = (data.rates.TWD * 1.02).toFixed(3); } catch(e) { alert('æ›´æ–°å¤±æ•—'); }
                };

                const addExpense = () => { if(newExpense.value.amount) { expenses.value.unshift({...newExpense.value}); newExpense.value.amount=''; newExpense.value.desc=''; } };
                const getBalance = (p) => {
                    const paid = expenses.value.filter(e => e.payer === p).reduce((sum, e) => sum + Number(e.amount), 0);
                    return Math.round(paid - (totalExpense.value / travelers.value.length));
                };
                const updateTravelers = () => {}; // Trigger computed

                // Storage
                const KEY = 'tokyo_v34_native';
                onMounted(() => {
                    const saved = localStorage.getItem(KEY);
                    if(saved) {
                        try {
                            const data = JSON.parse(saved);
                            itinerary.value = data.itinerary || itinerary.value;
                            wishlist.value = data.wishlist || [];
                            rate.value = data.rate || 0.215;
                            expenses.value = data.expenses || [];
                            travelerInput.value = data.travelerInput || 'æˆ‘, æ—…ä¼´';
                        } catch(e) { console.log('Data reset'); }
                    }
                });

                watch([itinerary, wishlist, rate, expenses, travelerInput], () => {
                    try { localStorage.setItem(KEY, JSON.stringify({
                        itinerary: itinerary.value, wishlist: wishlist.value, rate: rate.value, expenses: expenses.value, travelerInput: travelerInput.value
                    })); } catch(e) { alert('ç©ºé–“å·²æ»¿'); }
                }, { deep: true });

                const resetData = () => { localStorage.removeItem(KEY); location.reload(); };

                return {
                    currentTab, showSettings, viewingImage,
                    currentDayIndex, itinerary, addDay, addEvent, removeEvent,
                    getMapLink, getDailyRouteLink, getRouteLink,
                    listType, wishlist, newItem, addItem, deleteItem, filteredList,
                    handleImageUpload, viewImage, deleteViewingImage,
                    rate, jpyAmount, fetchRate,
                    travelerInput, travelers, expenses, newExpense, addExpense, totalExpense, getBalance, updateTravelers,
                    resetData
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
